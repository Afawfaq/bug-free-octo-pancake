name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly security scan on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install linters
        run: |
          pip install flake8 pylint black isort shellcheck-py

      - name: Run flake8
        run: |
          flake8 --max-line-length=120 --ignore=E501,W503 \
            orchestrator/*.py \
            advanced-monitor/*.py \
            attack-surface/*.py \
            iot/*.py \
            report/*.py || true

      - name: Check Python formatting with black
        run: |
          black --check --diff \
            orchestrator/*.py \
            advanced-monitor/*.py \
            attack-surface/*.py || true

      - name: Lint shell scripts
        run: |
          find . -name "*.sh" -exec shellcheck {} \; || true

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install test dependencies
        run: |
          pip install pytest pytest-cov pytest-mock

      - name: Run unit tests
        run: |
          # Run tests if they exist
          if [ -d "tests" ]; then
            pytest tests/ -v --cov=. --cov-report=xml
          else
            echo "No tests directory found, skipping tests"
          fi

      - name: Upload coverage report
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (filesystem)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-fs-results.sarif'

  build-containers:
    name: Build Docker Containers
    runs-on: ubuntu-latest
    needs: [lint, test]
    strategy:
      matrix:
        container:
          - orchestrator
          - passive
          - discovery
          - fingerprint
          - iot
          - nuclei
          - webshot
          - report
          - advanced-monitor
          - attack-surface
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build container - ${{ matrix.container }}
        run: |
          if [ -f "${{ matrix.container }}/Dockerfile" ]; then
            docker build -t recon-${{ matrix.container }}:latest ${{ matrix.container }}/
          else
            echo "Dockerfile not found for ${{ matrix.container }}, skipping..."
          fi

  docker-compose-validation:
    name: Validate Docker Compose
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose.yml
        run: |
          docker compose config --quiet

      - name: Check docker-compose syntax
        run: |
          docker compose config > /dev/null 2>&1 && echo "✅ docker-compose.yml is valid" || echo "❌ docker-compose.yml has errors"

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check markdown files
        run: |
          # Check that required documentation exists
          required_docs=(
            "README.md"
            "CONTRIBUTING.md"
            "LICENSE"
            "CHANGELOG.md"
          )
          
          missing=()
          for doc in "${required_docs[@]}"; do
            if [ ! -f "$doc" ]; then
              missing+=("$doc")
            fi
          done
          
          if [ ${#missing[@]} -gt 0 ]; then
            echo "⚠️ Missing documentation files: ${missing[*]}"
          else
            echo "✅ All required documentation files present"
          fi

      - name: Markdown link checker
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check-config.json'
        continue-on-error: true

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-containers, docker-compose-validation]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from CHANGELOG
        id: version
        run: |
          VERSION=$(grep -m1 "^## \[" CHANGELOG.md | sed 's/.*\[\(.*\)\].*/\1/' || echo "0.0.0")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Check if tag exists
        id: check_tag
        run: |
          if git rev-parse "v${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        if: steps.check_tag.outputs.exists == 'false'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.version }}
          release_name: Release v${{ steps.version.outputs.version }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: false
